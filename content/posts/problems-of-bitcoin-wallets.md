---
title: "Проблема Биткоин-кошельков"
date: 2020-01-12T00:00:00+00:00
categories: [Биткоин, UX]
---

Биткоин внутренне состоит из таких механик, которые до него нигде так широко не использовались и которые не знакомы массовому пользователю. Как сделать так, чтобы пользователь, не знакомый с этими механиками, смог пользоваться Биткоином? Провести параллель с чем-то знакомым. С кошельком (физическим), например, или с банковским приложением. Адрес, баланс, поступление, списание, входящие и исходящие переводы, история переводов — это ведь все из банковского мира. А как бы мог выглядеть интерфейс точно отражающий механику Биткоина?

История транзакций несёт в себе некоторые риски: если запрашивать транзакции из сети, то другие ноды смогут связать запрашиваемые адреса с IP-адресом вашей ноды. Да и нужен ли список транзакций, если все адреса обезличены? Что действительно важно, так это видеть текущую транзакцию в мемпуле, а также неплохо было бы видеть её очередь.

Приход и расход — термины из учета финансов, для которых нету аналогов в Биткоине. Битки не пересылаются от отправителя к получателю. Вместо этого суммы разбиваются на части, и для каждой части устанавливаются новые права доступа с помощью криптографии. И тоже ведь не особо важно, от кого пришло и кому ушло, если адреса неперсонализированы.

Адрес. Для каждой транзакции нужно генерировать новый уникальный адрес, переиспользовать их нельзя. Благо эта проблема давно решена с помощью детерминистических адресов. И опять же, если адрес одноразовый, то его особо не нужно видеть, и использованные адреса тоже не зачем видеть. Единственное, зачем нужно показывать адрес — чтобы скопировать его и вставить где-то.

Баланс важен, всем нужно его знать. Т. к. адреса переиспользуются, то и баланс будет не один, а у каждого адреса будет свой. И эта проблема тоже решена. Добавлю, что баланс считывается из UTXO-сета.

В итоге получается не так уж и много:
1. Seed-фраза и детерминистические адреса.
2. Отслеживание текущих транзакций из мемпула.
3. Отслеживание балансов по UTXO-сету.
4. Калькулятор комиссий, который уже есть во всех кошельках.
5. Ну и минимальный интерфейс.

То есть не так уж и много надо. В интерфейсе это было бы:
1. Экран инициализации с seed-фразой и установкой пароля.
2. Кнопки New transaction и Get address.
3. Форма создания новой транзакции.
4. Список транзакций из мемпула, относящихся к адресам пользователя.
5. Ещё что-то по мелочи.

Теперь о реализации. Для seed-фразы и генерации адресов сеть не нужна — это можно делать на стороне клиента при наличии надежных криптографических библиотек.

Отслеживание мемпула делается не сложно: нужно подключаться к сети Биткоина, получать все новые транзакции и отфильтровывать те, что не относятся к адресам пользователя.

Проверка баланса по UTXO-сету это серьезная проблема. Во-первых, необходимо этот UTXO-сет построить, для чего нужно синхронизировать полную ноду. Во-вторых, Bitcoin Core не позволяет получать баланс из UTXO-сета по адресу без дополнительных финтов. Есть два способа проверки баланса через ноду:
1. Перед началом синхронизации надо создать аккаунты и добавить в них адреса для отслеживания. По мере синхронизации нода будет отслеживать транзакции, относящиеся к этим адресам, и считать баланс.
2. Включить в настройках `txindex=1` чтобы проиндексировать все транзакции. Это требует полной синхронизации ноды. После этого можно будет проверять баланс для любого адреса, но индексы транзакций займут ещё несколько десятков гигабайт на диске.

Калькулятор комиссий тоже непросто сделать. Можно считать размер комиссии только по мемпулу, а можно ещё учитывать прошлые блоки (что Bitcoin Core и делает).

Самый популярный облегчённый кошелёк на сегодня — Electrum — работает в связке со своим сервером. По умолчанию, он подключается к серверу, запущенному кем-то. Сервер работает в связке с полной Биткоин-нодой и требует дополнительно более 50 Гб места для собственных данных: он индексирует транзакции, UTXO и блоки для построения истории транзакций. Т. е. выполняет ту работу, которую как бы должна делать сама нода.

Получается, что Bitcoin Core нода плохо предназначена для использования в качестве кошелька или некоего общего клиента Биткоина. Причины этого кроются в том, что это именно P2P-нода, которая в первую очередь должна выполнять свои нодовские функции:
1. Восстанавливать актуальное состояние блокчейна.
2. Определять самую длинную ветку (консенсус).
3. Принимать и отправлять транзакции в сеть.
4. (Опционально) принимать транзакции от других нод, верифицировать их и передавать другим нодам.
5. (Опционально) отдавать состояние блокчейна другим нодам, помогать им синхронизироваться.

Именно поэтому самым лучшим Биткоин-кошельком на сегодня является полная Биткоин-нода с дополнительным индексом для построения истории транзакций — это то, что делает Electrum.