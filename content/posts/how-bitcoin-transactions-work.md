---
title: "Как работают Биткоин-транзакции"
date: 2020-02-04T00:00:00+00:00
categories: [Биткоин, Криптография]
---

(Это вводный пост перед разбором Taproot. Чтобы понять Taproot, нужно сначала разобраться с тем, как работают транзакции в Биткоине.)

Биткоин-транзакция состоит из двух ключевых элементов: входы (inputs) и выходы (outputs). **Биткоины перемещаются не с адреса на адрес, а с выхода одной транзакции на выход другой транзакции.** И по сути, биткоины хранятся именно на выходах транзакций, а не на адресах. А входы служат связующим звеном между выходами и используются только в момент создания транзакции. Входы одной транзакции всегда указывают на выходы другой, более ранней, — именно так и определяется, какие биткоины участвуют в транзакции.

А что же адреса? Адреса являются частью скриптов, они прописываются только в коде скрипта. **Скрипты описывают логику аутентификации: проверки права на расходование выхода, или, другими словами, права на создание транзакции, использующий конкретный выход.** Права на расходования могут быть любыми, можно сделать транзакцию, которая даст доступ к биткам тому, кто решит уравнение `2+2=?`. Но, конечно же, в Биткоине используются более надёжные скрипты.

Прежде чем говорить о самих скриптах, обратим внимание на такой важный момент: в транзакции скрипт разбит на две части. Одна часть сохраняется во входе, а другая — в выходе. Скрипт разбивается по такому принципу:
1. В выход записывается «запирающий» скрипт, который задаёт логику проверки права на битки. В уравнении выше это было бы `2+2=`.
2. Во вход сохраняются параметры, которые передаются в выход предыдущей транзакции. Именно эти параметры (если они верные) и «отпирают» выход предыдущей транзакции. В уравнении выше это было бы просто `4`.

Получается, при создании транзакции перед вами стоит задача «отпереть» ранее «запертые» биткоины, указав правильные параметры для запирающего скрипта, который уже записан в ранее добытой транзакции. В новой транзакции вы разбиваете битки на части (одна часть — сдача) и запираете их на новых выходах, указав запирающий скрипт. По сути, происходит не движение биткоинов, а **разбитие суммы на части и изменение прав владения разными частями**.

Теперь поговорим про виды скриптов, или виды транзакций.
Изначально существовал только способ **P2PKH** (Pay to public key hash), оплата на хэш публичного ключа. Он же является самым распространённым сегодня, т. к. хэш публичного ключа это и есть Биткоин-адрес, т. е. P2PKH — это и есть «перевод биткоинов с адреса на адрес». В запирающей части скрипт **требует публичный ключ, соответствующий прописанному в скрипте хэшу (адресу)**, а также проверяет подпись транзакции с помощью этого ключа. Т. е. задача сводится к тому, чтобы предоставить исходные данные хэша (т. е. публичный ключ) и подтвердить владение соответствующим приватным ключом с помощью подписи транзакции. **Именно эти механизмы и гарантируют вам право владения вашими биткоинами**, так как ни SHA-256 (используется для хеширования), ни ECDSA (используется для подписи) ещё не были взломаны и возможно не будут при нашей жизни. И тут же важный момент: когда вы создаёте новую транзакцию, **вы обязаны раскрыть свой публичный ключ**, — это одна из причин, почему никогда нельзя переиспользовать Биткоин-адреса.

Другой тип скриптов — **P2SH** (Pay to script hash), оплата на хэш скрипта. Как следует из названия, в скрипте указывается не хэш публичного ключа, а хэш **другого скрипта**, который (скрипт) должен храниться приватно. Этот скрипт может быть любым, каким вы захотите и несколько позволяют возможности самого языка Script (который довольно примитивен). Это может быть, например, скрипт мультиподписи, escrow или платежного канала (те самые HTLC) — вы можете прописать в скрипте несколько логических ветвей и выполнить любую из них, в зависимости от параметров, которые вы укажете во входе в новой транзакции.

По сути, P2SH это способ сэкономить место в транзакции, вынеся скрипт вовне и прописав в выходе только его хэш. Чтобы потратить битки, отправленные на хэш скрипта, **нужно предоставить весь скрипт** — это главный недостаток этого способа, т. к. вы вынуждены раскрыть всю логику скрипта, в которой, например, могут быть прописаны адреса всех, кто мог получить доступ к биткоинам.

Напоследок пара слов о Segwit.
Segwit изменил место хранения подписей и скриптов в транзакциях. Раньше подписи и параметры скрипта хранились во входе, а вторая часть скрипта — в выходе. Теперь они вынесены за пределы транзакции, в новое поле в блоке, которое называется witness. Также скрипты теперь называются программой, witness-программой. P2PKH и P2SH эволюционировали в P2WPKH и P2WSH (т. е. с приставкой witness), а также изменился их код: он стал намного более компактным и стандартизированным.
Для новых witness-программ был создан новый тип Segwit-выходов, для которых были также изменены правила верификации.

Ну, этого должно быть достаточно.