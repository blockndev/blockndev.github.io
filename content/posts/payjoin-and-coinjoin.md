---
title: "Payjoin и Coinjoin: что это и что лучше"
date: 2020-04-20T00:00:00+00:00
categories: [Биткоин]
---

На днях вышла новая версия платежного процессора BTCPay Server, которая наделала немало шуму. Главная из новых фишек это поддержка Payjoin (также известный как P2EP, Pay to EndPoint). Шум вызвало заявление разработчиков о том, что Payjoin лучше, чем Coinjoin. Разберемся, что это вообще такое, в чем польза, и кто действительно лучше.

Оба этих алгоритма пытаются залатать одну и ту же дыру в анонимности Биткоина. Как вы знаете, транзакции Биткоина состоят из входов и выходов: биткоины перемещаются с выходов на выходы и хранятся на них, а входы используются в качестве связующего звена. Когда вы создаете новую транзакцию, вы (точнее ваш кошелек) должны указать выходы, с которых в будете выходить биткоины. Эти выхода должны, очевидно, принадлежать вам — и это создает проблему для анонимности: самим фактом создания транзакции вы признаетесь в том, что все выходы (а значит и адреса), с которых транзакция выходит биткоины, принадлежат вам. Сервисам аналитики блокчейна не составляет никаких проблем выявить эти связи и построить все цепочки адресов, принадлежащих одному владельцу. Чтобы построить эти связи, мы должны предположить, что все адреса, используемые во входах транзакции, принадлежат одному человеку. И это действительно так, если вы пользуетесь обычными кошельками, но Биткоин дает возможность сделать это предположение ложным без изменения протокола.

Одна из важных особенностей транзакций Биткоина состоит в том, что транзакции могут быть созданы коллективно. Вы можете создать транзакцию, включить в неё свои входы-выходы, подписать их и отдать транзакцию другу, который включит в неё свои входы-выходы, подпишет их и отправит транзакции в сеть. Транзакции Биткоина позволяют выходить с разных адресов, которые не обязательно должны принадлежать вам. (Кстати, именно так и работает batching транзакций: когда пользователи бирж выходят биткоины на кошельки, биржи выходят их не сразу, а складывают все входы-выходы в одну транзакцию — это снижает нагрузку на сеть Биткоина и снижает комиссии за транзакции.)

Но что, если у вас нету друга, с которым вы могли бы постоянно объединять транзакции? На помощь приходят сервисы и кошельки, которые поддерживают coinjoin. Самый популярный из них это Wasabi Wallet — пользователи этого кошелька смешивают транзакции друг с другом в защищенной и анонимной сети, так чтобы никто из них не смог проанализировать информацию о транзакции другого пользователя. Помимо этого, coinjoin-транзакции создаются таким образом, чтобы максимально скрыть связь между входами и выходами, чтобы никто не мог найти, какие входы с какими выходами соотносятся (в транзакциях эта связь явно не указывается). И это создает проблему — проанализировав какое-то количество транзакции, можно явно сказать, какие из них использовали сoinjoin, т. к. все coinjoin-транзакции имеют схожий «отпечаток».

Payjoin решает ту же проблему единого владельца входов транзакции, но делает это чуть иначе: т. к. BTCPay Server это платежный процессор, который связывает покупателей и продавцов, то смешиваются транзакции именно покупателя и продавца.
1. Покупатель создает транзакции, оплачивающую товар/услугу. Это полностью валидная транзакция, которая содержит вход, выходы и подпись.
2. Покупатель отправляет транзакцию покупателю напрямую — связующим звеном здесь служит сервер BTCPay Server.
3. Продавец получает транзакцию, добавляет в неё свой вход (т. е. тратит в этой транзакции свои биткоины), меняет сдачу покупателя и комиссию так, чтобы комиссия осталась прежней, и отправляет транзакцию обратно покупателю.
4. Покупатель получает транзакцию, переподписывает её и отправляет в сеть.

Рассмотрим пример того, как входы могут смешиваться в Payjoin:
1. Вы покупаете товар за 1 биткоин.
2. Вы создаете транзакцию и кладете в неё вход, расходующий 3 биткоина. 2 биткоина идут вам на сдачу (создается соответствующий выход).
3. Покупатель получает транзакцию и добавляет в неё свой вход на 5 биткоинов. 6 биткоинов идут ему на сдачу.

Получается: в входах 3+5=8 биткоинов, в выходах 2+6=8. И нельзя точно сказать, сколько именно было оплачено и сколько владельцев было у входов. Например, эту транзакцию можно интерпретировать так: вы отправили 6 биткоинов и получили 2 биткоина сдачи.

Главное преимущество этого способа — не нужно разбивать выходы по какой-то определённой схеме, пытаясь скрыть связь между входами и выходами. Payjoin-транзакции не имеют «отпечатка» и их невозможно отличить от обычных транзакций, т. к. они используют два входа и выхода. Но и свои недостатки тоже есть:
1. Оба участника должны быть онлайн одновременно.
2. Транзакция становятся больше, а значит и комиссия становится дороже.
3. Отправка транзакции занимает чуть больше времени.


Последнее, что ту можно ещё добавить. Payjoin также называется P2EP, Pay to EndPoint. Это название было предложено разработчиками из Blockstream в 2018, когда они работали над улучшение анонимности входов транзакций. Собственно технология, которую они разработали и называется P2EP. Это тоже coinjoin, но для обмена между сторонами он использует URI из BIP21 — это идентификатор вида `bitcoin:адрес?параметр=значение`. В Payjoin покупатель должен знать, как отправить транзакцию продавцу напрямую — для этого нужно знать его URL, который и передается как параметр в BIP21-адресе.