---
title: "Криптография Биткоина"
date: 2020-02-20T00:00:00+00:00
categories: [Биткоин, Криптография]
---

Многие считают, что криптография это шифрование, но на самом деле криптография это далеко не только шифрование. И особенно это актуально для Биткоина и вообще крипты. Ни Биткоин, ни подавляющее большинство других криптопроектов не используют шифрование (Лайтнинг использует, кстати).

С криптографией в Биткоине все просто. Вот полный список криптографических алгоритмов, которые в нем используются:
1. SHA-256
2. RIPEMD-160
3. ECDSA

**SHA-256** — это часть стандарта хэширующих функций SHA-2. В него также входят SHA-224, 384 и 512. Хэш-функции это однонаправленные функции, которые проецируют входящие данные на последовательность случайных байт фиксированной длинны. Если другими словами: хэш-функции позволяют создавать уникальный «отпечаток», идентифицирующий какие-то данные. Такие «отпечатки» называются хэшами. 
Число в названии алгоритма указывает на длину хэша в битах. Биткоин использует 256 бит как наиболее оптимальное значение по соотношению безопасность/длина/скорость.
К криптографическим хэш-функциям предъявляют следующие требования:
1. Хэши должны быть случайными и должны браться из равномерного распределения.
2. Не должно быть возможности восстановить исходные данные по хэшу.
3. Нельзя найти разные входящие данные, у которых будут одинаковые хэши.
4. Данные, отличающиеся даже совсем незначительно, должны производить совершенно непохожие и несвязанные хэши.

Хэш-функции удобно использовать для идентификации каких либо произвольных данных. В Биткоине SHA-256 используется для:
1. Создания ID блока, который просто является хэшем заголовка блока (в котором содержатся: версия ноды, хэш предыдущего блока, корень дерева транзакций, время добычи блока, сложность майнинга, nonce).
2. Создания ID транзакции — точно так же берётся хэш от параметров транзакции.
3. Создания хэша публичного ключа (но только как один из этапов алгоритма генерации адреса).

Последнее, что тут стоит сказать: для большей надежности Биткоин делает двойное хэширование всех данных. Сначала берётся хэш от исходных данных (блок, транзакция, публичный ключ), а котом берётся хэш от этого хэша. Это позволяет защититься от одной уязвимости, от которой страдают все SHA-2 функции.

**RIPEMD160** — это тоже хэш-функция, но попроще. Она производит хэши длиной 160 бит или 20 байт. Единственное, для чего этот алгоритм используется в Биткоине, это создание адреса:
1. Сначала публичный ключ дважды хэшируется SHA-256.
2. Затем один раз — RIPEMD-160.
3. К получившемуся хэшу добавляют версию и чексумму и пропускают через алгоритм Base58, который является копией Base64, но с удаленными символами, которые похожи друг на друга (l, I и т. д.).

Третий шаг нужен только для создания визуально читаемых адресов, в P2PKH-транзакциях он не выполняется, в выход транзакции записывается `RIPEMD-160(SHA-256(SHA-256(pubKey)))`.

**ECDSA**. Если вы никогда не сталкивались с криптографией, тот этот алгоритм будет для вас настоящим открытием. Как я уже сказал, криптография это далеко не только шифрование — очень важную роль в криптографии играют ещё и алгоритмы аутентификации. 

(Аутентификация в широком смысле это проверка подлинности чего-либо. Аутентификация требует предварительного этапа регистрации или идентификации — это справедливо как для веб-приложений, так и для криптотранзакций.)

Криптография делится на две области:
1. Симметричная криптография, в которой все алгоритмы используют только один секретный ключ. Шифрование относится как раз к этой области, но существуют также и симметричные алгоритмы аутентификации.
2. Криптография с открытым ключом, в которой используется пара ключей: приватного (секретного) и публичного. Именно этой области обязаны своим существованием криптовалюты. Именно об этой области криптографии мы будем говорить всегда, когда будем обсуждать криптографические механики.

Криптография с открытым ключом базируется на уравнении вида: `a * b = c`, где `b` и `c` публичны и открыты, но `a` восстановить очень-очень сложно и дорого. Такие уравнения возможны благодаря модульной арифметике, в которой все операции проводятся по модулю и для создания надёжных (т. е. труднообратимых) уравнений используется модуль очень большого простого числа. Задача восстановления числа `a` называется задачей решения дискретного логарифма, и у этой задачи на текущий момент нету эффективных решений.

Как вы уже наверно догадались, в уравнении выше: `a` это приватный ключ, `b` это некое число-параметр алгоритма, `c` это публичный ключ. Зная публичный ключ и алгоритм, которым он был получен, восстановить приватный ключ должно быть практически невозможно. В то же время, имея приватный ключ и алгоритм, возможно получить один публичный ключ, соответствующий этому приватному ключу.

ECDSA — это алгоритм цифровой подписи, использующий математику эллиптических кривых для:
1. создания публичного ключа (не приватного!)
2. генерации подписи
3. проверки подписи.

Эллиптические кривые это сложная математическая модель, в которую мы не будем углубляться. Нам достаточно знать только то, что:
1. Она делает уравнение выше ещё более сложным для решения.
2. Публичный ключ это точка на кривой с координатами `x`, `y`.
3. `b` из уравнения выше становится `G` — базовой точкой конкретного типа кривых (их несколько).

Получается уравнение: `p * G = P`, где `p` это приватный ключ (здесь и далее будем записывать строчной буквой), `G` — базовая точка кривой,  `P` — публичный ключ (заглавная буква). (Иногда вместо умножения пишут возведение в степень.)

Приватный ключ генерируется отдельно, т. к. это просто случайное число. Конкретно для Биткоина нужно генерировать приватный ключ длиной 32 байта. **Очень важно использовать для этого криптографические библиотеки, а не математические!**

Последнее, что нужно сказать: в Биткоине используется тип кривых secp256k1 (обратите внимание на k1; ещё есть r1). Кроме Биткоина и других криптопроектов эти кривые больше нигде не используются, потому что этот тип кривых был стандартизирован разработчиками Биткоина специально для Биткоина. Этот тип кривых отсутствует во всех стандартных криптографических библиотеках и чипах, потому что он так и не был принят главным «стандартизирующим органом» NIST, Национальным институтом стандартов и технологий США. Если вы встретите тип кривых P-256, то знайте, что это secp256r1, и он не совместим с кривыми, используемыми в Биткоине (он создаёт другие публичные ключи и подписи).

А тонкости создания и проверки подписи нам особо не важны. Достаточно знать что:
1. Для создания подписи нужен приватный ключ и исходные данные.
2. Для проверки подписи нужен публичный ключ, подпись и исходные данные.
3. Проверка подписи это алгоритм аутентификации: проверка даёт узнать, были ли данные подписаны приватным ключом, соответствующим имеющемуся у нас публичному ключу. В Биткоине подпись проверяет факт владения биткоинами: если вы можете предоставить подпись и публичный ключ, на который были переведены битки, то вы являетесь их владельцем.
