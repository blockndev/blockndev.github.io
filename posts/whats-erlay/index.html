<!DOCTYPE html>
<html lang="ru">
<meta charset="utf-8">
<title>Erlay: протокол эффективного распространения транзакций Биткоина | Блокчейн &amp; Разработка</title>
<link rel="icon" href="/favicon.ico">
<meta name="generator" content="Hugo 0.70.0-DEV" />
<meta name="description" content="Блог о разработке и блокчейн-технологиях. Код, сети, паранойя.">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="https://blockndevcomcss/index.css">
<link rel="stylesheet" href="https://blockndevcomcss/classes.css">
<link rel="canonical" href="https://blockndevcom/posts/whats-erlay/">
<link rel="alternate" type="application/rss+xml" href="" title="Блокчейн &amp; Разработка">

<body>

<header class="icons">
  <i class="col-1">&nbsp;</i>
  
    <a class="col-1" href="https://blockndevcom">Блокчейн &amp; Разработка</a>
  
  
    <nav class="col-1 navigation">
    
      <a href="https://t.me/blockndev" >
        
          
          
          <span ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm121.8 169.9l-40.7 191.8c-3 13.6-11.1 16.9-22.4 10.5l-62-45.7-29.9 28.8c-3.3 3.3-6.1 6.1-12.5 6.1l4.4-63.1 114.9-103.8c5-4.4-1.1-6.9-7.7-2.5l-142 89.4-61.2-19.1c-13.3-4.2-13.6-13.3 2.8-19.7l239.1-92.2c11.1-4 20.8 2.7 17.2 19.5z"/></svg></span>
          <span class="hidden">Telegram</span>
        
      </a>
    
      <a href="mailto:me@jeiwan.ru" >
        
          
          
          <span ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M502.3 190.8c3.9-3.1 9.7-.2 9.7 4.7V400c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V195.6c0-5 5.7-7.8 9.7-4.7 22.4 17.4 52.1 39.5 154.1 113.6 21.1 15.4 56.7 47.8 92.2 47.6 35.7.3 72-32.8 92.3-47.6 102-74.1 131.6-96.3 154-113.7zM256 320c23.2.4 56.6-29.2 73.4-41.4 132.7-96.3 142.8-104.7 173.4-128.7 5.8-4.5 9.2-11.5 9.2-18.9v-19c0-26.5-21.5-48-48-48H48C21.5 64 0 85.5 0 112v19c0 7.4 3.4 14.3 9.2 18.9 30.6 23.9 40.7 32.4 173.4 128.7 16.8 12.2 50.2 41.8 73.4 41.4z"/></svg></span>
          <span class="hidden">Mail</span>
        
      </a>
    
      <a href="https://github.com/Jeiwan" >
        
          
          
          <span ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
          <span class="hidden">Github</span>
        
      </a>
    
      <a href="/index.xml" >
        
          
          
          <span ><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M128.081 415.959c0 35.369-28.672 64.041-64.041 64.041S0 451.328 0 415.959s28.672-64.041 64.041-64.041 64.04 28.673 64.04 64.041zm175.66 47.25c-8.354-154.6-132.185-278.587-286.95-286.95C7.656 175.765 0 183.105 0 192.253v48.069c0 8.415 6.49 15.472 14.887 16.018 111.832 7.284 201.473 96.702 208.772 208.772.547 8.397 7.604 14.887 16.018 14.887h48.069c9.149.001 16.489-7.655 15.995-16.79zm144.249.288C439.596 229.677 251.465 40.445 16.503 32.01 7.473 31.686 0 38.981 0 48.016v48.068c0 8.625 6.835 15.645 15.453 15.999 191.179 7.839 344.627 161.316 352.465 352.465.353 8.618 7.373 15.453 15.999 15.453h48.068c9.034-.001 16.329-7.474 16.005-16.504z"/></svg></span>
          <span class="hidden">Subscribe</span>
        
      </a>
    
    </nav>
  
</header>

<article>
  <header>
    <a href="https://blockndevcom/categories/%D0%B1%D0%B8%D1%82%D0%BA%D0%BE%D0%B8%D0%BD/">БИТКОИН</a><h1>Erlay: протокол эффективного распространения транзакций Биткоина</h1>
    <time datetime="2020-04-02T00:00:00Z">02 April 2020</time>
  </header>
  <p>Наш соотечественник Глеб Науменко, работающий сейчас в Blockstream, разработал новый, более оптимизированный способ распространения транзакций в сети Биткоина, который называется Erlay. Алгоритм позволяет увеличить количество соединений между нодами (что повышает безопасность сети) и при этом снизить трафик, генерируемый передачей транзакций от ноды к ноде, на 40%.</p>
<p>Сеть Биткоина устроена таким образом, что каждая нода получает каждую транзакцию и каждый блок. Когда вы отправляете транзакцию, нода, которая её получает, отправляет её всем нодам, к которым она подключена. Эти ноды рассылают транзакцию всем нодам, к которым они подключены — так транзакция расходится по всей сети. Сейчас это занимает чуть больше 4 секунд.</p>
<p>У такого способа распространения есть несколько недостатков:</p>
<ol>
<li>Ноды в холостую гоняют одни и те же транзакции. Одна может получать одну и ту же транзакцию несколько раз. Эта проблема была частично решена тем, что вместо самих транзакций сначала рассылаются только айдишники — если у ноды нету транзакции с конкретным айдишником, она запросит всю транзакцию.</li>
<li>Невозможно увеличить количество соединений между нодами. Различные исследования показывают, что чем больше соединений между нодами в P2P-сети, тем труднее проводить некоторые виды атак. Если сейчас увеличивать количество соединений в сети Биткоина, то сильно вырастет трафик, как раз по большей части из-за спама транзакций.</li>
</ol>
<p>Именно эти проблемы и решает Erlay.</p>
<p>Биткоин-ноды можно разделить на два типа:</p>
<ol>
<li>Публичные. Это ноды, которые подключаются к другим нодам в сети (исходящие соединений) и позволяют другим нодам подключаться к ним (входящие соединения). По умолчанию, нода открывает 8 исходящих соединений и принимает до 125 входящих соединений.</li>
<li>Приватные. Это ноды, которые подключатся к другим нодам, но входящих соединений не разрешают. Они так же по умолчанию подключаются к 8 другим нодам.</li>
</ol>
<p>Оба типа имеют 8 исходящих подключений, значит каждая нода отправляет каждую транзакцию на 8 других нод — и в этом как раз и есть главный недостаток текущего способа рассылки транзакций. В идеале, кол-во отправленных транзакции должно быть равно количеству нод N, а в текущей реализации получается 8N.</p>
<p>Именно вот эти 8 исходящих соединений хотелось бы увеличить, чтобы сделать сеть более защищённой, но в текущей реализации сети этого сделать нельзя, потому что это ещё больше увеличит спам транзакциями и трафик, который создаёт нода. Больше трафика — труднее и дороже запускать ноду.</p>
<p>Идея Глеба состоит в том, чтобы сократить спам транзакциями и добавить новый механизм сверки и согласования транзакций между нодами.
Теперь транзакции будут рассылаться только публичными нодами (нодами с большим количеством входящих соединений) и только на 8 исходящих соединений (даже если их отрыто больше). Главная задача тут — снизить трафик и при этом разместить транзакции в сети таким способом, чтобы они располагались близко к нодам. Например, нода может не получить новую транзакцию, но транзакция с высокой вероятность будет у одной из нод, к которым она подключена, или в паре «прыжков» от неё. Это снизит трафик, увеличит безопасность (больше соединений = безопаснее сеть), но ноды будут получать не все транзакции. И это решается с помощью нового алгоритма, который называется Minisketch. Алгоритм построен вокруг структуры данных под названием скетч (sketch). Я не смог найти описание этой структуры данных на русском языке (вероятно они сами её изобрели), поэтому перескажу своими словами.</p>
<ol>
<li>Скетч это структура, оптимизированная для сравнения двух множеств и выявления различий между ними. В данном случае множества состоят из айдишников транзакций.</li>
<li>Скетчи хранят множества в запакованном виде. В этом смысле они похожи на хэши, из которых можно восстанавливать исходные данные.</li>
<li>Скетчи сравниваются между собой операцией XOR. Результат сравнения — скетч разницы двух множеств.</li>
<li>Скетч разницы представляет собой симметрическую разность двух множеств, т. е. он содержит айдишники транзакций: а) которых нету у текущей ноды; б) которых нету у ноды, с которой была проведена сверка.</li>
</ol>
<p>У скетчей есть один недостаток: чтобы найти различия между множествами, необходимо оценить (предугадать) их количество. Если оценка больше реального количества различий, то алгоритм сработает. Если меньше, то нода переключится на альтернативный способ (по тестам такое происходит в 0.7% случаев), который заключается в том, чтобы сверить с другой нодой не полное множество, а только половину: благодаря линейности скетчей, имея разницу половины транзакций, можно достроить оставшиеся транзакции. Если и этот способ не срабатывает (4.3% случаев по тестам), то нода выполняет стандартную синхронизацию транзакций.</p>
<p>Что получается в итоге:</p>
<ol>
<li>Рассылкой занимаются только публичные ноды и только на 8 исходящих соединений.</li>
<li>Не все ноды получают новые транзакции, но транзакции распределяются по сети примерно равномерном.</li>
<li>Ноды периодически (каждую секунду) проводят сверку транзакций с помощью скетчей.</li>
<li>Благодаря тому, что транзакции распределены по сети равномерно, сверка работает быстро.</li>
<li>В итоге снижается трафик и увеличивается количество соединений между нодами, что делает сеть безопаснее.</li>
</ol>
<p>Ещё одна интересная деталь, о которой стоит сказать: в новом протоколе для распространения собственных транзакций используется сверка, а не рассылка. Т. е. когда вы создаёте и отправляете транзакцию, нода передаст её другим нодам через сверку, а не через отправку напрямую. При сверке айдишники транзакций не раскрываются, поэтому узнать ноду, с которой транзакция была отправлена, невозможно. Это затруднит работу сервисов, шпионящих за транзакциями в сети Биткоина.</p>
<p>Оригинальный пейпер, в котором много деталей и графиков: <a href="https://arxiv.org/pdf/1905.10518.pdf">https://arxiv.org/pdf/1905.10518.pdf</a></p>
<p>Erlay получил BIP номер 330: <a href="https://github.com/bitcoin/bips/blob/master/bip-0330.mediawiki">https://github.com/bitcoin/bips/blob/master/bip-0330.mediawiki</a></p>
<p>И уже идёт работа над кодом: <a href="https://github.com/bitcoin/bitcoin/pull/18261">https://github.com/bitcoin/bitcoin/pull/18261</a></p>

</article>



</body>

</html>
